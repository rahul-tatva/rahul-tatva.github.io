/*! 20210601-30-RELEASE 2021-06-01 */

const TYPES={BID:"bid",PIXEL:"pixel"},COMPETITORS={TEADS:"teads"};(()=>{class t{constructor(t){this.sessionId=t["session-id"],this.countryCode=t["country-code"],this.domain="trc.taboola.com",this.isDetecting=!1,this._loadDistanceFromArticle(),this.templateKeys=["account_id","ad","adUrl","cSyncUrl","cpm","creativeId","currency","dealId","debug","ext","height","id","isNetCpm","nbr","nobids","sbi_dc","site_id","size_id","status","tracking","ttl","version","width","zone_id","placementMetadata","settings","viewerId","wigoEnabled","noAdReason"],this.resMapping={ad_id:"id",advertiser:"advid",campaign_id:"cmpid",cpm:"cpm",creative_id:"crid",error_code:"err_code",impression_id:"impid",network:"network",reason:"reason",rtb_rule_id:"rtb_rule_id",script:"script",seat:"seatid",size_id:"sizeid",status:"status",type:"type",adm:"script",advid:"advid",buying_type:"buying_type",cid:"cid",crid:"crid",h:"height",id:"id",isNet:"isNet",lid:"lid",nurl:"nurl",pid:"pid",w:"width",ad:"script",bidId:"bidid",placementCode:"placement_code",ad_profile_id:"ad_profile_id",auction_id:"aucid",nobid:"nobid",tag_id:"tid",uuid:"uuid",ad_source_id:"advid",connection_id:"cid",content:"vast",dsp_campaign_id:"cmpid",dsp_creative_id:"crid",insertion_id:"insid",placement_id:"placement_code",portfolio_item_id:"prtfid",scenario_id:"sid"}}_loadDistanceFromArticle(){if(!TRC.DistanceFromArticle||!TRC.DistanceFromArticle.measure)return;const t=TRC.DistanceFromArticle.measure();t&&t.articleElement?this.articleElRect=t.articleElement.getBoundingClientRect():this.articleElRect={}}detect(){return!this.isDetecting&&(this.isDetecting=!0,this._listenToNetwork(),!0)}_listenToNetwork(){this._hookToXHRCalls(),this._hookToImages()}static hasProperty(t,e){return Object.prototype.hasOwnProperty.call(t,e)}_hookToXHRCalls(){if(TRC.BidDetection.hasProperty(XMLHttpRequest.prototype,"_open"))return;const t=this;XMLHttpRequest.prototype._open=XMLHttpRequest.prototype.open,XMLHttpRequest.prototype.open=function(e,i,s,r,o){if(i.indexOf("taboola")<0){const e=(new Error).stack.indexOf("teads-format")>-1;e&&(this._url=i,this._qs=TRC.URL.prototype.getQueryStringObj.call(i),this._onreadystatechange=this.onreadystatechange,this.onreadystatechange=function(){this.readyState===XMLHttpRequest.DONE&&(t._report(this,COMPETITORS.TEADS,TYPES.BID),this._onreadystatechange&&this._onreadystatechange())})}this._open(e,i,s,r,o)}}_hookToImages(){if(TRC.BidDetection.hasProperty(HTMLImageElement.prototype,"_src")||!TRC.BidDetection.hasProperty(HTMLImageElement.prototype,"src"))return;const t=this;Object.defineProperty(HTMLImageElement.prototype,"_src",Object.getOwnPropertyDescriptor(HTMLImageElement.prototype,"src")),Object.defineProperty(HTMLImageElement.prototype,"src",{get(){return this._src},set(e){const i=(new Error).stack.indexOf("teads-format")>-1;i&&(this._src=e,this._qs=TRC.URL.prototype.getQueryStringObj.call(e),this._qs.action&&t._reportToDB(COMPETITORS.TEADS,TYPES.PIXEL,e,{},this._qs,{})),this._src=e}})}_report(t,e,i){try{const s=JSON.parse(t.responseText),r=this._createBidResTemplate(s),o={article:this.articleElRect||{},ad:{}};let d=[];s.ads&&s.ads.length>0?d=s.ads:s.bid&&s.bid.length>0?d=s.bid:s.bids&&s.bids.length>0?d=s.bids:s.tags&&s.tags.length>0&&(d=s.tags),d.length>0?d.forEach(s=>{let d=JSON.parse(JSON.stringify(r));d=this._createAdBidRes(s,d),this._reportToDB(e,i,t._url,t._body,t._qs,d,o)}):this._reportToDB(e,i,t._url,t._body,t._qs,r,o)}catch(s){this._reportToDB(e,i,t._url,t._body,t._qs,{},{})}}_reportToDB(t,e,i,s,r,o,d){const a={sessionId:this.sessionId,timestamp:(new Date).toISOString(),bidder:t,action:e,publisherId:TRC.publisherId,isMobile:!TRC.dom.isDesktop(),fullPageUrl:window.location.href,reqBody:s,bidRes:o,bidUrl:i,querystring:r,placement:d};TRC.TRCLogger.get(`${window.location.protocol}//${this.domain}`,"page-load",{tim:__trcClientTimestamp(),"page-load-data":JSON.stringify(a)},TRC.publisherId)}_createBidResTemplate(t){const e={};return this.templateKeys.forEach(i=>{e[i]=t[i]}),t.alt_size_ids&&Array.isArray(t.alt_size_ids)&&(e.alt_size_ids=t.alt_size_ids.join("x")),e}_createAdBidRes(t,e){return Object.keys(this.resMapping).forEach(i=>{if(TRC.BidDetection.hasProperty(t,i)){const s=this.resMapping[i];e[s]=t[i]}}),e}}TRC.BidDetection=t})();